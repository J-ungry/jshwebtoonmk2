{% extends "nav.html" %}
{% block title %}ìŠ¹í™˜ì´ë„¤ ë§Œí™”ë°©{% endblock %}

{% block content %}
<!-- css ì¤‘ë³µë˜ëŠ” ì½”ë“œê°€ ë„ˆë¬´ ë§ì•„ì„œ ìˆ˜ì • í•„ìš” -->
<style>
    ul li {
        cursor: pointer;
    }

    ul li:hover {
        background-color: #efefef;
    }

    /* ì„œì •ìš°í•œí…Œ ë§¡ê¸´ë‹¤. */
    ul li:hover {
        background-color: #94bada;
    }

    .container {
        width: 70%;
    }

    .find-recommend {
        display: flex;
        justify-content: space-between;
        border: 1px solid #000;
    }

    .button-result {
        border: 0;
        outline: 0;
        width: 100%;
        background-color: #fff;
    }

    .button-result:hover {
        background: #EEE;
    }

    /* í‚¤ì›Œë“œ ê²€ìƒ‰ ë°” */
</style>


<div class="container">


    <!-- ì‚¬ìš©ì keyword ì…ë ¥ -->
    <div style="margin: 0 auto;">
        <div class="p-3 d-flex justify-content-between align-items-center" style="background-color: #252c3a;">
            <div class="align-self-center">
                <img class="rounded float-start" style="width:40px;"
                    src="{{url_for('static',filename='img/baseline_search_white_24dp.png')}}">
                <span class="me-1" style="color: #fff; font-size: 27px;"><strong>ì›¹íˆ° í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•˜ê¸°</strong></span>
                <span style="color: #fff;">í‚¤ì›Œë“œë¡œ ë§ˆìŒì— ë“œëŠ” ì›¹íˆ°ì„ ì°¾ì•„ë³´ì„¸ìš”!</span>

            </div>
            <div class="p-2 release-btn" style="border: 1px solid #fff; border-radius: 5px; cursor: pointer;">
                <p style="color: #fff;"><strong>ì „ì²´ í•´ì œ</strong></p>
            </div>
        </div>
        <!-- focus ì¶”ê°€, height ì¶”ê°€(ì˜ì•ˆëŒ..) -->
        <div class="p-2 d-flex justify-content-between" style="background-color: #e6f6ff; border: 1.5px solid #cddde6;">
            <div class="w-25 me-2 p-2">
                <h5 class="p-1" style="font-size: 15px; font-weight: lighter; border-bottom: 1.5px solid #cddde6;">ì¥ë¥´
                </h5>
                <div style="height: 100px; overflow: auto;">
                    <ul style="font-weight: bolder; color: #23466e;" class="p-2">
                        <!-- ì¥ë¥´ -->
                        {% for gen in genre %}
                        <li name="1" class="p-1 user_keyword">{{gen}}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="w-25 me-2 p-2">
                <h5 class="p-1" style="font-size: 15px; font-weight: lighter; border-bottom: 1.5px solid #cddde6;">ì†Œì¬
                </h5>
                <div style="height: 100px; overflow: auto;">
                    <ul style="font-weight: bolder; color: #23466e;" class="p-2">
                        <!-- ì†Œì¬ -->
                        {% for soj in sojae %}
                        <li name="2" class="p-1 user_keyword">{{soj}}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="w-25 me-2 p-2">
                <h5 class="p-1" style="font-size: 15px; font-weight: lighter; border-bottom: 1.5px solid #cddde6;">ë¶„ìœ„ê¸°
                </h5>
                <div style="height: 100px; overflow: auto;">
                    <ul style="font-weight: bolder; color: #23466e;" class="p-2">
                        <!-- ë¶„ìœ„ê¸° -->
                        {% for atm in atm %}
                        <li name="3" class="p-1 user_keyword">{{atm}}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="w-25 me-2 p-2">
                <h5 class="p-1" style="font-size: 15px; font-weight: lighter; border-bottom: 1.5px solid #cddde6;">
                    ë“±ì¥ì¸ë¬¼/ê´€ê³„
                </h5>
                <div style="height: 100px; overflow: auto;">
                    <ul style="font-weight: bolder; color: #23466e;" class="p-2">
                        <!-- ë“±ì¥ì¸ë¬¼/ê´€ê³„ -->
                        {% for chr in chrel %}
                        <li name="5" class="p-1 user_keyword">{{chr}}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="w-25 me-2 p-2">
                <h5 class="p-1" style="font-size: 15px; font-weight: lighter; border-bottom: 1.5px solid #cddde6;">ìˆ˜ìƒì‘
                </h5>
                <div style="height: 100px; overflow: auto;">
                    <ul style="font-weight: bolder; color: #23466e;" class="p-2">
                        <!-- ìˆ˜ìƒì‘ -->
                        {% for soo in soosang %}
                        <li name="4" class="p-1 user_keyword">{{soo}}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="w-25 me-2 p-2">
                <h5 class="p-1" style="font-size: 15px; font-weight: lighter; border-bottom: 1.5px solid #cddde6;">ì›ì‘ì›¹íˆ°
                </h5>
                <div style="height: 100px; overflow: auto;">
                    <ul style="font-weight: bolder; color: #23466e;" class="p-2">
                        <!-- ì›ì‘ì›¹íˆ° -->
                        {% for ori in origin %}
                        <li name="6" class="p-1 user_keyword">{{ori}}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- <div class="find-recommend"> í‚¤ì›Œë“œëª… ê²€ìƒ‰ ( ë‚˜ì¤‘ì— ajax ë¡œ ì²˜ë¦¬í•´ì•¼í•¨ ), ë²„íŠ¼ ë‘ê°œê°€ ë“¤ì–´ìˆëŠ” div -->
    <!-- <label for="autoComplete">ì›¹íˆ°ëª… ê²€ìƒ‰</label> -->
    <div> <!--í‚¤ì›Œë“œëª… ê²€ìƒ‰ ( ë‚˜ì¤‘ì— ajax ë¡œ ì²˜ë¦¬í•´ì•¼í•¨ )-->
        <label for="inputAutoCompleteKeyword">í‚¤ì›Œë“œ ê²€ìƒ‰</label>
        <input name="title" type="text" id="inputAutoCompleteKeyword" autocomplete="off" placeholder="í‚¤ì›Œë“œ ì…ë ¥">
        <input type='button' class="addAutoCompleteKeyword" value='ì¶”ê°€' />
    </div>
    <div id="select_keyword" class="d-flex">

    </div>
    <div id="output_keyword">
        <form action='/recommendation' method="POST" id='reload_location'>
            <!-- <button id="recommend" type="submit">Recommend</button> -->
        </form>
    </div>
    <!-- </div> -->

</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript">

    //ìë™ì™„ì„± í´ë¦­ ì‹œ í‚¤ì›Œë“œ ì¶”ê°€ í•„ìš”

    const release_btn = document.getElementsByClassName("release-btn");
    const output = document.getElementById("reload_location")
    let select_user_keyword = []

    const test = document.getElementById("test");
    // ë²„íŠ¼íƒœê·¸ test
    $('.button-result').on('click', function (event) {
        console.log($(this).attr('value'))
    })

    //ë¦¬ìŠ¤íŠ¸ ì„ íƒì‹œ ë°œìƒ
    const select_user = document.getElementById("select_keyword")
    $('li').on('click', function (event) {

        // const select_user = document.getElementById("select_keyword")

        let keyword = $(this).attr('name')
        let user_keyword = $(this).text()

        //ë™ì¼í•œ ê°’ ì•ˆë“¤ì–´ê°€ë„ë¡ ìˆ˜ì •
        if (select_user_keyword.includes(user_keyword)) {
            return
        } else {
            select_user_keyword.push(user_keyword);
        }
        console.log(select_user_keyword)

        $.ajax({
            type: 'POST',
            url: '/input_keyword',
            data: { "keyword": keyword, "user_keyword": user_keyword },
            dataType: "json",
            success: function (response) {
                for (let prop in select_user_keyword) {
                    if (user_keyword == select_user_keyword[prop]) {
                        fun_key = user_keyword.replace(' ', '_')
                        select_user.innerHTML += `
                            <div id="keyword_btn${prop}">
                                <button type="button" class="btn btn-info">${select_user_keyword[prop]}</button>
                                <button onclick="remove_btn(${prop},'${fun_key}')" name="${prop}" type="button" class="btn-close" aria-label="Close"></button>
                            </div>
                        `
                    }
                }

                const list_len = $(response["webtoon_title"]).length

                output.innerHTML += `<div id="${fun_key}" class="keywords">`

                let keyword_result = document.getElementById(fun_key)
                for (let i = 0; i < list_len; i++) {
                    //ì „ì²´ë¥¼ divë¥¼ ê°ì‹¼ë‹¤. ì–´ë–¤ í‚¤ì›Œë“œë¥¼ ì‚­ì œí• ì§€ ì•Œì•„ì•¼í•¨

                    keyword_result.innerHTML += `
                        <a class="button-result" href="/get_rcm/${response["webtoon_title"][i]}">
                            <div>
                                <img src='${response["webtoon_thumb"][i]}' style="width:100px; height:100px">
                            </div>  

                            <div>
                                <p>${response["webtoon_title"][i]}</p>
                            </div>

                            <div>
                                <p>${response["webtoon_author"][i]}</p>
                            </div>
                            <div>
                                <p>${response["webtoon_intro"][i]}</p>
                            </div>                    
                        </a>

                    `
                }
                output.innerHTML += `</div>`
            },
            error: function (request, status, error) {
                console.log("no ajax")
            }
        });
    })

    // í‚¤ì›Œë“œ ì‚­ì œ ë²„íŠ¼
    function remove_btn(number, keyword) {
        index = "keyword_btn" + number;
        const close_number = document.getElementById(index);
        const div_container = document.getElementById(keyword);
        select_user_keyword.splice(index, 1);
        div_container.remove(); // ë³´ì—¬ì¤€ ì›¹íˆ° ëª©ë¡ì„ ì‚­ì œ
        close_number.remove();  // í‚¤ì›Œë“œ ëª©ë¡ì—ì„œ ì„ íƒí•œ í‚¤ì›Œë“œë¥¼ ì‚­ì œ
    }


    // í‚¤ì›Œë“œ ê²€ìƒ‰ ìë™ì™„ì„±
    $('#inputAutoCompleteKeyword').autocomplete({
        source: function (request, response) { //source: ì…ë ¥ì‹œ ë³´ì¼ ëª©ë¡
            $.ajax({
                url: "/keyword_autocomplete"
                , type: "POST"
                , data: { value: request.term }	// ê²€ìƒ‰ í‚¤ì›Œë“œ
                , success: function (data) { 	// ì„±ê³µ
                    response(
                        $.map(data.keywordList, function (item) {
                            return {
                                label: item  	// ëª©ë¡ì— í‘œì‹œë˜ëŠ” ê°’
                                , value: item		// ì„ íƒ ì‹œ inputì°½ì— í‘œì‹œë˜ëŠ” ê°’
                            };
                        })
                    );    //response
                }
                , error: function () { //ì‹¤íŒ¨
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
        , focus: function (event, ui) { // ë°©í–¥í‚¤ë¡œ ìë™ì™„ì„±ë‹¨ì–´ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ì–´ì¤Œ	
            return false;
        }
        , minLength: 1// ìµœì†Œ ê¸€ììˆ˜
        , autoFocus: false // true == ì²« ë²ˆì§¸ í•­ëª©ì— ìë™ìœ¼ë¡œ ì´ˆì ì´ ë§ì¶°ì§
        , delay: 100	//autocomplete ë”œë ˆì´ ì‹œê°„(ms)

    });


    $(release_btn).on('click', function (event) {
        let select_user = document.getElementById("select_keyword")
        let keywords = $(output).find('div')
        select_user_keyword = []
        select_user.innerHTML = ''
        keywords.remove();
    });

    // ê²€ìƒ‰í•œ í‚¤ì›Œë“œ ì¶”ê°€ ë²„íŠ¼
    $('.addAutoCompleteKeyword').on('click', function (event) {
        const inputValue = document.getElementById('inputAutoCompleteKeyword').value;
        console.log("inputValue :", inputValue);

        $.ajax({
            type: 'POST',
            url: '/addAutoCompleteKeyword',
            data: { "inputValue": inputValue },
            dataType: "json",
            success: function (response) {
                console.log(response);
                const { existInDB } = response;
                if (existInDB) {
                    const { inputValue, keyword_type, webtoon_title,
                        webtoon_author, webtoon_thumb, webtoon_intro } = response;
                    console.log("ê²€ìƒ‰í•œ í‚¤ì›Œë“œ :", inputValue);
                    console.log("ê²€ìƒ‰í•œ í‚¤ì›Œë“œê°€ DBì— ìˆì–´ìš”âœ¨");

                    let keyword = keyword_type
                    let user_keyword = inputValue

                    //ë™ì¼í•œ ê°’ ì•ˆë“¤ì–´ê°€ë„ë¡ ìˆ˜ì •
                    if (select_user_keyword.includes(user_keyword)) {
                        return
                    } else {
                        select_user_keyword.push(user_keyword);
                    }
                    console.log(select_user_keyword)

                    for (let prop in select_user_keyword) {
                        if (user_keyword == select_user_keyword[prop]) {
                            fun_key = user_keyword.replace(' ', '_')
                            select_user.innerHTML += `
                            <div id="keyword_btn${prop}">
                                <button type="button" class="btn btn-info">${select_user_keyword[prop]}</button>
                                <button onclick="remove_btn(${prop},'${fun_key}')" name="${prop}" type="button" class="btn-close" aria-label="Close"></button>
                            </div>
                        `
                        }
                    }

                    const list_len = $(response["webtoon_title"]).length

                    output.innerHTML += `<div id="${fun_key}" class="keywords">`

                    let keyword_result = document.getElementById(fun_key)
                    for (let i = 0; i < list_len; i++) {
                        //ì „ì²´ë¥¼ divë¥¼ ê°ì‹¼ë‹¤. ì–´ë–¤ í‚¤ì›Œë“œë¥¼ ì‚­ì œí• ì§€ ì•Œì•„ì•¼í•¨

                        keyword_result.innerHTML += `
                        <a class="button-result" href="/get_rcm/${response["webtoon_title"][i]}">
                            <div>
                                <img src='${response["webtoon_thumb"][i]}' style="width:100px; height:100px">
                            </div>  

                            <div>
                                <p>${response["webtoon_title"][i]}</p>
                            </div>

                            <div>
                                <p>${response["webtoon_author"][i]}</p>
                            </div>
                            <div>
                                <p>${response["webtoon_intro"][i]}</p>
                            </div>                    
                        </a>

                    `
                    }
                    output.innerHTML += `</div>`

                    $('#inputAutoCompleteKeyword').val('');

                } else {
                    const { inputValue } = response;
                    console.log("ê²€ìƒ‰í•œ í‚¤ì›Œë“œ :", inputValue);
                    console.log("ê²€ìƒ‰í•œ í‚¤ì›Œë“œê°€ DBì— ì—†ì–´ìš”ğŸ’¥");
                    alert('ê²€ìƒ‰í•œ í‚¤ì›Œë“œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            },
            error: function (request, status, error) {
                console.log("no ajax")
            }
        });

    })
</script>
{% endblock %}